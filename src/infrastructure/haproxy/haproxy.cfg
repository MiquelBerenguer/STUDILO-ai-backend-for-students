# haproxy.cfg - Configuración para PostgreSQL HA

global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp           # Usamos modo TCP para PostgreSQL, no HTTP
    option  tcplog
    option  dontlognull
    timeout connect 5000  # 5 segundos
    timeout client  50000 # 50 segundos
    timeout server  50000 # 50 segundos

# --- Frontend: Dónde escucha HAProxy ---
frontend postgres_frontend
    bind *:5432           # HAProxy escuchará en el puerto 5432 (interno de Docker)
    mode tcp
    default_backend postgres_backend

# --- Backend: Dónde están los servidores de BBDD ---
backend postgres_backend
    mode tcp
    balance roundrobin    # Usamos roundrobin, pero 'option pgsql-check' asegurará que solo vaya al master
    option pgsql-check user ${POSTGRES_USER} # ¡Importante!

    # --- Servidores PostgreSQL ---
    # 1. HAProxy hará un 'pgsql-check' a ambos servidores.
    # 2. El 'check' fallará en la réplica (porque está en modo recovery/solo lectura).
    # 3. El 'check' tendrá éxito en el master.
    # 4. HAProxy solo enviará tráfico al servidor que pase el 'check' (el master).
    
    server postgres-master postgres-master:5432 check
    server postgres-replica postgres-replica:5432 check